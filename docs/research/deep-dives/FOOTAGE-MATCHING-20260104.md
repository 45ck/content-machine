# Footage Matching Research: Stock Video/Image Selection Patterns

**Date:** 2026-01-04  
**Scope:** MoneyPrinterTurbo, short-video-maker-gyori, ShortGPT  
**Focus:** How vendored repos match video/image footage to script content

---

## Executive Summary

All three repos use **keyword-based search** against stock footage APIs (primarily Pexels). **No embedding-based semantic search** is used. Search terms are generated by LLMs from script content, then passed directly to API endpoints. Key patterns include:

1. **LLM generates search terms** from script/captions (1-3 words per term)
2. **Multiple fallback terms** per scene (typically 3 alternatives)
3. **Joker/fallback terms** when all searches fail (nature, globe, space, ocean)
4. **Duration filtering** to match scene length
5. **Resolution/aspect ratio filtering** before selection

---

## 1. Stock Footage API Integration

### 1.1 Pexels API (Primary in all repos)

**Endpoint:** `https://api.pexels.com/videos/search`

#### ShortGPT Implementation
**File:** [vendor/ShortGPT/shortGPT/api_utils/pexels_api.py](../../../vendor/ShortGPT/shortGPT/api_utils/pexels_api.py)

```python
def search_videos(query_string, orientation_landscape=True):
    url = "https://api.pexels.com/videos/search"
    headers = {
        "Authorization": ApiKeyManager.get_api_key("PEXELS_API_KEY")
    }
    params = {
        "query": query_string,
        "orientation": "landscape" if orientation_landscape else "portrait",
        "per_page": 15
    }
    response = requests.get(url, headers=headers, params=params)
    return response.json()
```

#### MoneyPrinterTurbo Implementation
**File:** [vendor/MoneyPrinterTurbo/app/services/material.py](../../../vendor/MoneyPrinterTurbo/app/services/material.py)

```python
def search_videos_pexels(
    search_term: str,
    minimum_duration: int,
    video_aspect: VideoAspect = VideoAspect.portrait,
) -> List[MaterialInfo]:
    params = {"query": search_term, "per_page": 20, "orientation": video_orientation}
    query_url = f"https://api.pexels.com/videos/search?{urlencode(params)}"
    
    # Filter by duration and resolution
    for v in videos:
        duration = v["duration"]
        if duration < minimum_duration:
            continue
        # Match exact resolution (1080x1920 for portrait, etc.)
        for video in video_files:
            if w == video_width and h == video_height:
                item.url = video["link"]
```

#### short-video-maker-gyori Implementation (TypeScript)
**File:** [vendor/short-video-maker-gyori/src/short-creator/libraries/Pexels.ts](../../../vendor/short-video-maker-gyori/src/short-creator/libraries/Pexels.ts)

```typescript
private async _findVideo(searchTerm: string, minDurationSeconds: number, ...): Promise<Video> {
    const response = await fetch(
      `https://api.pexels.com/videos/search?orientation=${orientation}&size=medium&per_page=80&query=${encodeURIComponent(searchTerm)}`,
      { headers: { "Authorization": this.API_KEY } }
    );
    
    // Filter: duration >= minDuration + 3s buffer
    // Filter: exact resolution match (1080x1920 for portrait)
    const filteredVideos = videos.filter(video => {
        if (duration >= minDurationSeconds + durationBufferSeconds) {
            for (const file of video.video_files) {
                if (file.quality === "hd" && 
                    file.width === requiredVideoWidth && 
                    file.height === requiredVideoHeight) {
                    return true;
                }
            }
        }
    });
    
    // Random selection from filtered results
    return filteredVideos[Math.floor(Math.random() * filteredVideos.length)];
}
```

### 1.2 Pixabay API (MoneyPrinterTurbo only)

**File:** [vendor/MoneyPrinterTurbo/app/services/material.py#L82-L129](../../../vendor/MoneyPrinterTurbo/app/services/material.py)

```python
def search_videos_pixabay(search_term: str, minimum_duration: int, ...) -> List[MaterialInfo]:
    params = {
        "q": search_term,
        "video_type": "all",  # "all", "film", "animation"
        "per_page": 50,
        "key": api_key,
    }
    query_url = f"https://pixabay.com/api/videos/?{urlencode(params)}"
```

### 1.3 Unsplash

**Not used** by any of the three repos for video. Only mentioned in documentation as potential alternative.

---

## 2. Search Query Generation (Keyword-Based)

### 2.1 ShortGPT: LLM-Generated Timed Queries

**File:** [vendor/ShortGPT/shortGPT/gpt/gpt_editing.py](../../../vendor/ShortGPT/shortGPT/gpt/gpt_editing.py)

```python
def getVideoSearchQueriesTimed(captions_timed):
    """
    Generate timed video search queries based on caption timings.
    Returns list of [time_range, search_queries] pairs.
    """
    chat, system = gpt_utils.load_local_yaml_prompt('prompt_templates/editing_generate_videos.yaml')
    prompt = chat.replace("<<TIMED_CAPTIONS>>", f"{captions_timed}")
    res = gpt_utils.llm_completion(chat_prompt=prompt, system=system)
    
    # Parse JSON response
    for segment in data["video_segments"]:
        time_range = segment["time_range"]
        queries = segment["queries"]  # Exactly 3 queries per segment
```

**Prompt Template:** [vendor/ShortGPT/shortGPT/prompt_templates/editing_generate_videos.yaml](../../../vendor/ShortGPT/shortGPT/prompt_templates/editing_generate_videos.yaml)

```yaml
# Key constraints from prompt:
# 1. Use ONLY English words
# 2. Keep queries between 1-2 words
# 3. Focus on visual, concrete objects or actions
# 4. Avoid abstract concepts
# 5. Each segment is 4-5 seconds long

# Good examples: "ocean waves", "typing keyboard", "city traffic"
# Bad examples: "feeling sad" (abstract), "beautiful nature landscape" (too long)

# Output format:
{
    "video_segments": [
        {
            "time_range": [0.0, 4.324],
            "queries": ["coffee steam", "hot drink", "morning breakfast"]
        }
    ]
}
```

### 2.2 MoneyPrinterTurbo: LLM Term Generation

**File:** [vendor/MoneyPrinterTurbo/app/services/llm.py#L405-L466](../../../vendor/MoneyPrinterTurbo/app/services/llm.py)

```python
def generate_terms(video_subject: str, video_script: str, amount: int = 5) -> List[str]:
    prompt = f"""
# Role: Video Search Terms Generator

## Goals:
Generate {amount} search terms for stock videos, depending on the subject of a video.

## Constrains:
1. the search terms are to be returned as a json-array of strings.
2. each search term should consist of 1-3 words, always add the main subject of the video.
3. you must only return the json-array of strings.
4. the search terms must be related to the subject of the video.
5. reply with english search terms only.

## Output Example:
["search term 1", "search term 2", "search term 3","search term 4","search term 5"]

## Context:
### Video Subject
{video_subject}

### Video Script
{video_script}
"""
    search_terms = json.loads(response)
    return search_terms
```

### 2.3 short-video-maker-gyori: User-Provided Search Terms

**File:** [vendor/short-video-maker-gyori/src/types/shorts.ts#L33-L40](../../../vendor/short-video-maker-gyori/src/types/shorts.ts)

```typescript
export const sceneInput = z.object({
  text: z.string().describe("Text to be spoken in the video"),
  searchTerms: z
    .array(z.string())
    .describe(
      "Search term for video, 1 word, and at least 2-3 search terms should be provided for each scene."
    ),
});
```

**Key Difference:** This repo expects **user/caller to provide search terms** per scene, rather than generating them automatically. The MCP interface or API caller is responsible for term generation.

---

## 3. Semantic vs Keyword Matching

### Finding: **All repos use keyword-based search only**

| Repo | Matching Type | Embedding Used? |
|------|---------------|-----------------|
| ShortGPT | Keyword (LLM-generated) | ❌ No |
| MoneyPrinterTurbo | Keyword (LLM-generated) | ❌ No |
| short-video-maker-gyori | Keyword (user-provided) | ❌ No |

**Why no semantic search?**
1. Pexels/Pixabay APIs only support keyword search
2. Building a local video embedding database would require:
   - Pre-downloading all stock footage
   - Running CLIP or similar models on each video
   - Maintaining a vector database
3. Trade-off: LLM-generated keywords are "good enough" for generic B-roll

### Potential Enhancement: Semantic Search Architecture

```
Script → LLM → Keywords → Pexels API → Results
                  ↓
            Embedding Model (CLIP)
                  ↓
         Local Vector DB (cached videos)
                  ↓
         Semantic similarity ranking
```

---

## 4. Video Selection Logic

### 4.1 Duration Matching

#### ShortGPT
**File:** [vendor/ShortGPT/shortGPT/api_utils/pexels_api.py#L31](../../../vendor/ShortGPT/shortGPT/api_utils/pexels_api.py)

```python
# Sort by how close duration is to 15 seconds (ideal clip length)
sorted_videos = sorted(filtered_videos, key=lambda x: abs(15-int(x['duration'])))
```

#### MoneyPrinterTurbo
**File:** [vendor/MoneyPrinterTurbo/app/services/material.py#L67-L72](../../../vendor/MoneyPrinterTurbo/app/services/material.py)

```python
# Filter: video must be >= minimum_duration
if duration < minimum_duration:
    continue
    
# Later: accumulate clips until total >= audio_duration
if total_duration > audio_duration:
    break
```

#### short-video-maker-gyori
**File:** [vendor/short-video-maker-gyori/src/short-creator/libraries/Pexels.ts#L83-L87](../../../vendor/short-video-maker-gyori/src/short-creator/libraries/Pexels.ts)

```typescript
const durationBufferSeconds = 3;  // Add 3s buffer

// Filter: duration must be >= required + buffer
if (duration >= minDurationSeconds + durationBufferSeconds) {
    // Also adjusts for FPS conversion: fps < 25 → duration * (fps / 25)
    const fps = video.video_files[0].fps;
    const duration = fps < 25 ? video.duration * (fps / 25) : video.duration;
}
```

### 4.2 Aspect Ratio Handling

All repos filter by **exact resolution match**:

| Orientation | Resolution | Aspect Ratio |
|-------------|------------|--------------|
| Portrait | 1080×1920 | 9:16 |
| Landscape | 1920×1080 | 16:9 |

```python
# ShortGPT
if orientation_landscape:
    filtered_videos = [v for v in videos if v['width'] >= 1920 and v['height'] >= 1080 and v['width']/v['height'] == 16/9]
else:
    filtered_videos = [v for v in videos if v['width'] >= 1080 and v['height'] >= 1920 and v['height']/v['width'] == 16/9]
```

```typescript
// short-video-maker-gyori
const { width: requiredVideoWidth, height: requiredVideoHeight } = getOrientationConfig(orientation);
// Filters to exact match: file.width === requiredVideoWidth && file.height === requiredVideoHeight
```

### 4.3 Deduplication

All repos track used videos to avoid repetition:

```python
# ShortGPT
used_links = []
for (t1, t2), search_terms in timed_video_searches:
    url = getBestVideo(query, used_vids=used_links)
    if url:
        used_links.append(url.split('.hd')[0])
```

```typescript
// short-video-maker-gyori
const video = await this.pexelsApi.findVideo(
    scene.searchTerms,
    audioLength,
    excludeVideoIds,  // Track and exclude used IDs
    orientation,
);
excludeVideoIds.push(video.id);
```

---

## 5. Video Download & Caching

### 5.1 MoneyPrinterTurbo: Hash-Based Cache

**File:** [vendor/MoneyPrinterTurbo/app/services/material.py#L131-L170](../../../vendor/MoneyPrinterTurbo/app/services/material.py)

```python
def save_video(video_url: str, save_dir: str = "") -> str:
    if not save_dir:
        save_dir = utils.storage_dir("cache_videos")  # Default cache location
    
    # Generate deterministic filename from URL hash
    url_without_query = video_url.split("?")[0]
    url_hash = utils.md5(url_without_query)
    video_id = f"vid-{url_hash}"
    video_path = f"{save_dir}/{video_id}.mp4"
    
    # Skip if already cached
    if os.path.exists(video_path) and os.path.getsize(video_path) > 0:
        logger.info(f"video already exists: {video_path}")
        return video_path
    
    # Download to cache
    with open(video_path, "wb") as f:
        f.write(requests.get(video_url, ...).content)
    
    # Validate downloaded video
    clip = VideoFileClip(video_path)
    if clip.duration > 0 and clip.fps > 0:
        return video_path
```

**Configuration:**
```toml
# config.example.toml
material_directory = ""        # Default: ./storage/cache_videos
material_directory = "task"    # Per-task isolation (no sharing)
material_directory = "/path"   # Custom shared cache
```

### 5.2 short-video-maker-gyori: Temp Directory + Optional LRU Cache

**File:** [vendor/short-video-maker-gyori/src/config.ts#L96-99](../../../vendor/short-video-maker-gyori/src/config.ts)

```typescript
// Environment-based cache size limit
if (process.env.VIDEO_CACHE_SIZE_IN_BYTES) {
    this.videoCacheSizeInBytes = parseInt(process.env.VIDEO_CACHE_SIZE_IN_BYTES);
}
// Default in Docker: 2GB (2097152000 bytes)
```

**Download logic:** [vendor/short-video-maker-gyori/src/short-creator/ShortCreator.ts#L148-169](../../../vendor/short-video-maker-gyori/src/short-creator/ShortCreator.ts)

```typescript
// Download to temp directory (per-render, not cached across renders)
const tempVideoPath = path.join(this.config.tempDirPath, tempVideoFileName);

await new Promise<void>((resolve, reject) => {
    const fileStream = fs.createWriteStream(tempVideoPath);
    https.get(video.url, (response) => {
        response.pipe(fileStream);
        fileStream.on("finish", () => {
            fileStream.close();
            resolve();
        });
    });
});
```

### 5.3 ShortGPT: No Explicit Caching

ShortGPT uses video URLs directly in the editing engine without local caching:

```python
# Videos are referenced by URL, FFmpeg streams from URL
timed_video_urls.append([[t1, t2], url])
# Later passed to editing engine which uses FFmpeg to fetch
```

---

## 6. Fallback Strategies

### 6.1 short-video-maker-gyori: Joker Terms

**File:** [vendor/short-video-maker-gyori/src/short-creator/libraries/Pexels.ts#L6-7](../../../vendor/short-video-maker-gyori/src/short-creator/libraries/Pexels.ts)

```typescript
const jokerTerms: string[] = ["nature", "globe", "space", "ocean"];

async findVideo(searchTerms: string[], ...): Promise<Video> {
    // Shuffle both user terms and joker terms
    const shuffledJokerTerms = jokerTerms.sort(() => Math.random() - 0.5);
    const shuffledSearchTerms = searchTerms.sort(() => Math.random() - 0.5);
    
    // Try user terms first, then fallback to jokers
    for (const searchTerm of [...shuffledSearchTerms, ...shuffledJokerTerms]) {
        try {
            return await this._findVideo(searchTerm, ...);
        } catch (error) {
            // Continue to next term
        }
    }
    throw new Error("No videos found in Pexels API");
}
```

### 6.2 ShortGPT: Multiple Queries Per Segment

**File:** [vendor/ShortGPT/shortGPT/engine/content_video_engine.py#L83-95](../../../vendor/ShortGPT/shortGPT/engine/content_video_engine.py)

```python
def _generateVideoUrls(self):
    for (t1, t2), search_terms in timed_video_searches:
        url = ""
        # Try each query in reverse order (last = most specific?)
        for query in reversed(search_terms):
            url = getBestVideo(query, orientation_landscape=not self._db_format_vertical, used_vids=used_links)
            if url:
                used_links.append(url.split('.hd')[0])
                break
        # url may be None if all queries fail
        timed_video_urls.append([[t1, t2], url])
```

### 6.3 MoneyPrinterTurbo: Multiple Terms, No Explicit Fallback

```python
def download_videos(task_id, search_terms: List[str], ...):
    for search_term in search_terms:
        video_items = search_videos(search_term, ...)
        for item in video_items:
            if item.url not in valid_video_urls:
                valid_video_items.append(item)
    
    # Randomly shuffle if configured
    if video_contact_mode.value == VideoConcatMode.random.value:
        random.shuffle(valid_video_items)
```

---

## 7. Summary: Key Patterns for content-machine

### Recommended Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Script/Caption Input                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│           LLM Search Term Generator (GPT-4o-mini)           │
│  - 4-5 second segments                                       │
│  - 3 alternative terms per segment                           │
│  - 1-2 words, concrete/visual                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Pexels API Search                           │
│  - Filter: orientation (portrait/landscape)                  │
│  - Filter: duration >= scene_duration + 3s buffer            │
│  - Filter: exact resolution (1080x1920 or 1920x1080)         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Fallback Strategy                           │
│  1. Try primary search terms                                 │
│  2. Try alternative terms                                    │
│  3. Try joker terms: ["nature", "globe", "space", "ocean"]  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Download & Cache                            │
│  - Hash-based caching (MD5 of URL)                          │
│  - LRU eviction with size limit                              │
│  - Validate: duration > 0, fps > 0                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Scene Assembly                              │
│  - Exclude already-used video IDs                            │
│  - Random selection from qualified results                   │
│  - Accumulate until total duration >= audio duration        │
└─────────────────────────────────────────────────────────────┘
```

### Implementation Checklist

- [ ] **Stock API Client**
  - [ ] Pexels API integration (primary)
  - [ ] Pixabay API integration (secondary)
  - [ ] API key rotation for rate limiting
  - [ ] Orientation/resolution filtering
  - [ ] Duration filtering with buffer

- [ ] **Search Term Generation**
  - [ ] LLM prompt for timed segments (4-5s)
  - [ ] 3 alternative terms per segment
  - [ ] JSON schema validation (Zod)
  - [ ] Retry logic for LLM failures

- [ ] **Fallback System**
  - [ ] Joker terms array
  - [ ] Shuffle and iterate through all terms
  - [ ] Graceful degradation (log, don't crash)

- [ ] **Caching Layer**
  - [ ] Hash-based file naming
  - [ ] Size-limited LRU cache
  - [ ] Video validation (duration, fps, resolution)
  - [ ] Per-task vs shared cache option

- [ ] **Future Enhancement: Semantic Search**
  - [ ] CLIP embeddings for downloaded videos
  - [ ] Vector DB (Qdrant) for similarity search
  - [ ] Hybrid: keyword search + semantic reranking

---

## 8. File Reference Index

| Pattern | ShortGPT | MoneyPrinterTurbo | short-video-maker-gyori |
|---------|----------|-------------------|-------------------------|
| **Pexels API** | [pexels_api.py](../../../vendor/ShortGPT/shortGPT/api_utils/pexels_api.py) | [material.py#L35-79](../../../vendor/MoneyPrinterTurbo/app/services/material.py) | [Pexels.ts](../../../vendor/short-video-maker-gyori/src/short-creator/libraries/Pexels.ts) |
| **Term Generation** | [gpt_editing.py](../../../vendor/ShortGPT/shortGPT/gpt/gpt_editing.py) | [llm.py#L405-466](../../../vendor/MoneyPrinterTurbo/app/services/llm.py) | N/A (user-provided) |
| **Prompt Template** | [editing_generate_videos.yaml](../../../vendor/ShortGPT/shortGPT/prompt_templates/editing_generate_videos.yaml) | Inline in llm.py | N/A |
| **Video Download** | N/A (URL streaming) | [material.py#L131-170](../../../vendor/MoneyPrinterTurbo/app/services/material.py) | [ShortCreator.ts#L148-169](../../../vendor/short-video-maker-gyori/src/short-creator/ShortCreator.ts) |
| **Fallback/Joker** | content_video_engine.py | N/A | [Pexels.ts#L6](../../../vendor/short-video-maker-gyori/src/short-creator/libraries/Pexels.ts) |
| **Duration Logic** | pexels_api.py#L31 | material.py#L67-72 | Pexels.ts#L83-87 |
| **Aspect Ratio** | pexels_api.py#L28-33 | material.py#L74-78 | Pexels.ts#L64-67 |

---

*Research compiled from vendor submodules. See individual files for full implementation details.*
