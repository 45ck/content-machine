# Runner + Provenance Contract: Local Experiment Lab

Date: 2026-02-06
Status: Draft (must be implemented exactly)

This document defines the _deterministic_ filesystem layout, command invocation rules, and provenance
capture required for Lab runner mode. This is the highest-risk area for subtle corruption (overwrites,
missing artifacts, irreproducible runs), so we standardize it up front.

## 1) Goals

1. No overwrites: baseline and variants never share an artifacts directory.
2. Reproducible: every run has a complete command/provenance record.
3. Portable: exports are meaningful even when the original filesystem is unavailable.
4. Safe: never store secrets; never allow arbitrary commands.

## 2) Runner enablement (capability gates)

Runner is disabled by default.

To enable runner:

- start Lab with `cm lab --enable-runner`

Additional capability flags (default false):

- `--runner-allow-network`
- `--runner-allow-workflow-exec`

Runner behavior must reflect these flags:

- If network is disallowed, runner must set `CM_OFFLINE=1` for child processes and reject any
  experiment spec that requires network (e.g. non-mock LLM research) unless the user overrides.
- If workflow exec is disallowed, runner must reject experiments that set `--workflow-allow-exec`.

## 3) Run directory layout (canonical)

All runner-produced outputs must live under a per-session root:

`~/.cm/lab/sessions/<sessionId>/`

Within a session:

- `runs/<runId>/` per run (the artifacts directory for that run)
- `experiments/<experimentId>/` experiment manifests and references
- `events.jsonl` session event log
- `exports/` optional server-side exports

### 3.1) Run directory contents

`~/.cm/lab/sessions/<sessionId>/runs/<runId>/`

Required files:

- `video.mp4` (or other output filename; videoPath must be recorded)
- `cm.generate.envelope.json` (the exact JSON envelope emitted by `cm generate --json`)
- `cm.generate.stderr.log` (captured stderr for debugging; no secrets should be printed here in JSON mode)
- `lab.run.json` (LabRun index entry snapshot; optional if stored elsewhere)

Expected Content Machine artifacts (best-effort, depends on flags):

- `script.json`
- `audio.wav`
- `timestamps.json`
- `visuals.json`
- `audio.mix.json` (optional)
- `sync-report.json` (optional)
- `caption-quality.json` (optional)
- `score.json` (optional)

Rule: the runner must always pass `--keep-artifacts` so these files persist.

### 3.2) Experiment directory contents

`~/.cm/lab/sessions/<sessionId>/experiments/<experimentId>/`

Required files:

- `experiment.json` (LabExperiment entity, including hypothesis, variants, targeted questions)
- `baseline.runId` (text file containing runId)
- `variants.json` (variantId -> runId mapping)

Optional:

- `runner.log` (high-level runner logs for this experiment)

## 4) Run naming and idempotency rules

### 4.1) runId assignment

In runner mode, `runId` should be generated by the Lab (UUID with prefix), not inferred from the
filesystem. This ensures uniqueness and prevents collisions.

Example:

- `run_01J...`

### 4.2) No overwrite policy

If a target run directory exists:

- Runner must not reuse it.
- Generate a new runId and a new directory.

This guarantees that re-running an experiment preserves history.

### 4.3) Optional import dedupe (review-only mode)

For manual imports, the server may dedupe by `realpath(artifactsDir)` (configurable), but runner mode
must never rely on dedupe.

## 5) Command invocation contract (child process)

Runner executes Content Machine via argv array (no shell):

- Preferred: `node <repoRoot>/dist/cli/index.cjs generate ...`
- Fallback: `cm generate ...` if globally installed and version-matched

Required flags:

- `--json` (machine output)
- `--keep-artifacts`
- `--output <runDir>/video.mp4`

Recommended flags (Lab defaults; can be overridden):

- `--quality` (or `--sync-preset quality` plus caption gate flags)

Forbidden behaviors:

- Never pass secrets on the command line.
- Never run an untrusted binary (runner must restrict execution to the project’s cm binary).

## 6) Provenance capture (must be complete)

Per run, record:

1. The raw JSON envelope from `cm generate --json` (`cm.generate.envelope.json`)
2. `argv` array used to spawn the command (stored in `lab.run.json` or in the run index store)
3. `cwd` used for the run
4. `cmVersion`:
   - from `cm --version` or from package metadata (best-effort)
5. `gitCommit`:
   - from `git rev-parse HEAD` when available (best-effort)
6. Runner capabilities at time of execution:
   - runnerEnabled, allowNetwork, allowWorkflowExec

Environment capture:

- Store _only_ an allowlist of env key names (never values).
- Always exclude: `OPENAI_API_KEY`, `PEXELS_API_KEY`, `TAVILY_API_KEY`, etc (store names only if needed).

## 7) Variant diff representation

For each variant, store:

- `label` (human readable)
- `diffFromBaseline`:
  - `addedFlags`: flags present only in variant
  - `changedFlags`: flags with different values
  - `removedFlags`: flags removed vs baseline

This is a machine-readable summary that the agent can use to map “what changed” to “what improved”.

## 8) Failure and partial results policy

If a run fails:

- The runner must still write:
  - stderr log
  - a failure record (error code/message) in `lab.run.json` / store
  - an event in the session event log

Runner must never delete partially created directories automatically. The agent/human can clean up.

## 9) Minimal tests (ship gate)

Runner correctness tests must verify:

- unique run dirs per baseline/variant
- `--keep-artifacts` is always passed
- output path is inside the run dir
- JSON envelope is captured and persisted
- provenance contains argv/cwd/version/commit (best-effort)
- forbidden flags are rejected when capabilities are disabled
