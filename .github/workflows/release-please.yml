name: Release Please

on:
  push:
    branches: [master]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Dispatch required checks for release PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const baseBranch = context.payload.repository.default_branch;
            const prefix = `release-please--branches--${baseBranch}--components--`;

            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            async function dispatchWithRetry({ workflow_id, ref, inputs }) {
              for (let attempt = 1; attempt <= 5; attempt++) {
                try {
                  await github.rest.actions.createWorkflowDispatch({
                    owner,
                    repo,
                    workflow_id,
                    ref,
                    inputs,
                  });
                  core.info(`Dispatched ${workflow_id} on ${ref}`);
                  return true;
                } catch (error) {
                  const status = error?.status;
                  const message = String(error?.message ?? error);

                  const isDispatchTriggerRace =
                    status === 422 && message.includes("Workflow does not have 'workflow_dispatch' trigger");

                  if (isDispatchTriggerRace && attempt < 5) {
                    core.warning(
                      `Dispatch for ${workflow_id} failed (attempt ${attempt}/5): ${message} â€” retrying...`
                    );
                    await sleep(5000);
                    continue;
                  }

                  core.warning(`Dispatch for ${workflow_id} failed: ${message}`);
                  return false;
                }
              }

              return false;
            }

            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: baseBranch,
              per_page: 100,
            });

            const releasePrs = pulls.filter((pr) => pr.head.ref.startsWith(prefix));
            if (releasePrs.length === 0) {
              core.info('No open release-please PR found; skipping dispatch.');
              return;
            }

            for (const pr of releasePrs) {
              core.info(`Dispatching workflows for PR #${pr.number} on ref ${pr.head.ref}`);

              await dispatchWithRetry({
                workflow_id: 'ci.yml',
                ref: pr.head.ref,
              });

              await dispatchWithRetry({
                workflow_id: 'codeql.yml',
                ref: pr.head.ref,
              });

              await dispatchWithRetry({
                workflow_id: 'dependency-review.yml',
                ref: pr.head.ref,
                inputs: {
                  base_ref: pr.base.ref,
                  head_ref: pr.head.ref,
                },
              });
            }
